# Matomo on Lagoon — NGINX vhost
server {
  # Lagoon’s nginx image listens on 8080 (ingress handles 80/443 + TLS)
  # ref: docs say default exposed port is 8080
  listen ${NGINX_LISTEN:-8080} default_server;

  # # Your Matomo route host; ingress does the SNI/host routing
  # server_name matomo.example.com;

  # Log to stdout/stderr for Kubernetes
  access_log /dev/stdout;
  error_log  /dev/stderr;

  # Lagoon images usually mount your app at /app
  root /app;             # make sure Matomo code is here
  index index.php;

  # Serve static files and common assets with short cache
  location ~* \.(gif|ico|jpg|jpeg|png|svg|js|css|htm|html|mp3|mp4|wav|ogg|avi|ttf|eot|woff|woff2)$ {
    expires 1h;
    add_header Pragma "public";
    add_header Cache-Control "public";
    try_files $uri =404;
  }

  # Matomo preview JS: no cache
  location ~ ^/js/container_.*_preview\.js$ {
    expires off;
    add_header Cache-Control "private, no-cache, no-store";
    try_files $uri =404;
  }

# Only allow specific PHP front controllers
location ~ ^/(index|matomo|piwik|js/index|plugins/HeatmapSessionRecording/configs)\.php$ {
    # Use the system fastcgi params; it already sets fastcgi_index
    include fastcgi_params;

    # Mitigate CVE-2019-11043
    try_files $fastcgi_script_name =404;

    # Required params
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO       $fastcgi_path_info;

    # Prevent httpoxy
    fastcgi_param HTTP_PROXY "";

    # PHP-FPM upstream service
    fastcgi_pass php:9000;
    # fastcgi_index index.php;  # <-- REMOVE this line (duplicate)
}

  # Deny all other PHP
  location ~* \.php$ {
    deny all;
    return 403;
  }

  # Default: try real files/dirs, 404 otherwise
  location / {
    try_files $uri $uri/ =404;
  }

  # Hard-deny sensitive Matomo dirs
  location ~ ^/(config|tmp|core|lang) {
    deny all;
    return 403;
  }

  # No dotfiles like .htaccess
  location ~ /\.ht {
    deny all;
    return 403;
  }

  # Render text files in root as text/plain
  location ~ /(.*\.md|LEGALNOTICE|LICENSE) {
    default_type text/plain;
  }
}